This folder contains the C# and R code that were used to do all analyzes in our manuscript "Multiscale mapping of transcriptomic signatures for cardiotoxic drugs" that is currently available as a preprint (10.1101/2021.11.02.466774).

The current code is deposited for test reasons.

--------------------------------------------------------------------------------
Below is a documentation of the directory structural and all needed experimental and databases files.
The downloaded zip-folder from gitHub contains the first two directories 'AA_csharp_code' and 'AA_R_code'.
The downloaded zip-folder from ... (link will be supplied) that contains all of our datasets contains all other directories listed below. 
Simply unzip and combine both downloaded folders and copy them to your hard drive (e.g. to 'D:' generating 'D:/LINCs_DToxS_SVD/').

--Your directory (e.g., 'D:/LINCs_DToxS_SVD/')
----AA_csharp_code
------1 C# solution file ('LINCS_DToxS_SVD.sln') and 9 subdirectories
----AA_R_code
------52 R-code files

----Cardiomyopathy_genomics
------Harper_2021_suppl_table_2.txt
------Pirruccello_2020_suppl_dataFile_3.txt

----Downloaded_datasets
------Chaffin_2022_singleNucleus_DCMvsNF.txt (optional, see below)
------Chaffin_2022_singleNucleus_HCMvsNF.txt (optional, see below)
------Chun_2023_downregulated_in_LVIP.txt (optional, see below)
------Chun_2023_upregulated_in_LVIP.txt (optional, see below)
------Koenig_2022_singleCell_DCMvsHealthy.txt (optional, see below)
------Litvinukova_2020_cellsAdultHumanHeart_global_raw.h5ad (optional, see below)

----Experimental_data (all datasets are part of zip-folder at predictox.org)
------Degs_initial_iPSCdCMs_EC
--------8 files with edgeR DEGs
------Degs_initial_iPSCdCMs_P0
--------266 files with edgeR DEGs
------Metadata
--------Drug_metadata.txt
--------FAERS_risk_profiles.txt
--------Lincs_experimental_metadata.txt
--------LincsDrugDosage_harmonized_names.txt
------RARG_variant
--------RARG_variant.txt
------Whole_genome_sequencing
--------annotated_combined.hg38_multianno_reheadered_withGWAS_withRSids.txt

----GeneDatabases_orthology
------Download
--------All_Data_gene_info.txt
--------gene2refseq.txt   
--------homologene.data
--------HOM_AllOrganism.rpt
--------ncbiRefSeq.All.hg38.gtf

----iPSCdCM_scRNAseq (all datasets are part of zip-folder at predictox.org)
------iPSCd_CM_marker_genes
------MSN01-3_control
--------raw_feature_bc_matrix
----------barcodes.tsv.gz
----------features.tsv.gz
----------matrix.mtx.gz
------MSN02-4_control
--------raw_feature_bc_matrix
----------barcodes.tsv.gz
----------features.tsv.gz
----------matrix.mtx.gz
------MSN08-13_control
--------raw_feature_bc_matrix
----------barcodes.tsv.gz
----------features.tsv.gz
----------matrix.mtx.gz
------MSN09-4_control
--------raw_feature_bc_matrix
----------barcodes.tsv.gz
----------features.tsv.gz
----------matrix.mtx.gz

------Libraries_for_enrichment
--------Download
----------Asp_2019_PMID_31835037_heartDevelopmentalCells.txt
----------ChEA_2016.txt
----------ENCODE_TF_ChIP_seq_2015.txt
----------full database.xml
----------GTEx_Analysis_v6p_RNA-seq_RNA-SeQCv1.1.8_gene_median_rpkm_mod.txt
----------HuGE_phenopedia.txt
----------KEA_2015.txt
----------MBCO_v1.1_gene-SCP_associations_human.txt
----------MBCO_v1.1_SCP_hierarchy.txt
----------TRANSFAC_and_JASPAR_PWMs.txt
----------TRRUST_Transcription_Factors_2019.txt
----------Tucker_2020_marker_genes_PMID 32403949 _suppl_table4.txt

------Results
--------ScSnRNAseq_enrichment (all datasets are part of zip-folder at predictox.org)
----------49 files with enrichment results

The indicated files can be downloaded from the following links. Since some files might have been updated and modified after we downloaded them, we also indicate our download dates. Please not that such updates influence the results generated by our pipeline.

---------------------------------------------

Initial LINCs datasets processed by pipeline:
Download the file ... from ... and unzip the file. Copy the directory to a your hard drive. Copy the code directories 'AA_csharp_code' and 'AA_R_code' obtained from this gitHub page into the directory.
Missing file name and link will be supplied soon.

---------------------------------------------

Subdirectory: ../Libraries_for_enrichment/Download/
https://go.drugbank.com/releases/latest: Download 'All drugs', unzip and copy the file 'full database.xml' into the subdirectory specified above.
(our download date: 2024 January 15)
https://maayanlab.cloud/Enrichr/#libraries: Download the libraries 'ChEA_2022.txt', 'ENCODE_TF_ChIP-seq_2015.txt', 'KEA_2015.txt', 'TRANSFAC_and_JASPAR_PWMs.txt', 'TRRUST_Transcription_Factors_2019.txt' and copy the files into the subdirectory specified above.
(our download date: 2024 January 15)
Rename the 'ENCODE_TF_ChIP-seq_2015.txt' into 'ENCODE_TF_ChIP_seq_2015.txt' (i.e., replace the hyphen by underline).
https://github.com/SBCNY/Molecular-Biology-of-the-Cell/tree/master/MBCO_datasets: Download the datasets 'MBCO v1.1 gene-SCP associations human.txt' and 'MBCO v1.1 SCP hierarchy.txt' into the subdirectory specified above.
(our download date: 2024 January 15)
https://www.gtexportal.org/home/downloads/adult-gtex#bulk_tissue_expression: Select 'Adult GTEx' and download the 'GTEx Analysis V6p' dataset 'GTEx_Analysis_v6p_RNA-seq_RNA-SeQCv1.1.8_gene_median_rpkm.gct.gz'. Unzip the file and delete the first two lines in that dataset using a text editor such as JujuEdit or NotePad and copy the new file with a new name 'GTEx_Analysis_v6p_RNA-seq_RNA-SeQCv1.1.8_gene_median_rpkm_mod.txt' (i.e., after addition of '_mod' and change of the file extension to '.txt') into the subdirectory specified above.
(our download date: 2016 August 26)
https://doi.org/10.1161/CIRCULATIONAHA.119.045401 or PMID:32403949: Download the 'supplemental tables (2).xlsx', copy paste the content of the sheet 'Table 4 IV MarkerGene' into a new document and delete the last line (1559). Delete all empty columns to the right of the last filled column (e.g., columns K - AG). If this step is skipped, the C# script might throw an exception due to existing columns that have the same column names (i.e. an empty string, ""). Save the new document as 'text (tab-delimited) (*.txt)' with the new name 'Tucker_2020_marker_genes_PMID 32403949 _suppl_table4.txt' into the subdirectory specified above.
https://doi.org/10.1016/j.cell.2019.11.025 or PMID:31835037: Download the supplemental table file '1-s2.0-S0092867419312826-mmc3.xlsx'. Merge the content of all sheets ('Cluster 1 - 14') into a new document. Ensure that the new document contains the headline only in the first line and does not contain any empty lines (including at the bottom of the file).  Delete all empty columns to the right of the last filled column (e.g., columns H - AG). If this step is skipped, the C# script might throw an exception due to existing columns that have the same column names (i.e. an empty string, "").  Save the new document as 'text (tab-delimited) (*.txt)' with the new name 'Asp_2019_PMID_31835037_heartDevelopmentalCells.txt' into the subdirectory specified above.
HuGE_phenopedia.txt: Download 'GENES TO PHENOTYPE' from 'https://hpo.jax.org/app/data/annotations', rename the file to 'HuGE_phenopedia.txt' and copy the file into the subdirectory specified above.
(our file was generated after downloading "Disease-GeneID.txt" from the HuGe Phenopedia website (download: 2020 June 04))

---------------------------------------------

Subdirectory: ../GeneDatabases_orthology/
https://ftp.ncbi.nlm.nih.gov/gene/DATA/: Download the file 'gene2refseq.gz', unzip, add the extension '.txt' and copy the file into the specified folder.
(our download: 2018June01)
https://ftp.ncbi.nlm.nih.gov/gene/DATA/GENE_INFO/: Download the file 'All_Data.gene_info.gz', unzip, rename the file to 'All_Data_gene_info.txt' (i.e. replace the dots within the file name by underlines and add the extension '.txt') and copy into the specified subdirectory.
(our download: 2018June01)
https://ftp.ncbi.nih.gov/pub/HomoloGene/build68/: Download the file 'homologene.data' (right click, select 'Save link as') and copy into the specified subdirectory.
(our download: 2024 January 15)
ncbiRefSeq.All.hg38.gtf: Go to https://genome.ucsc.edu, select Table Browser, make the following selections: "clade: Mammal", "genome: Human", "assembly: Dec. 2013 (GRCh38/hg38)", "group: Genes and Gene Predictions", "track: NCBI RefSeq", "table: RefSeq All (ncbiRefSeq)", "region: genome", "output format: GTF - gene transfer format (limited)", "output filename: ncbiRefSeq.All.hg38.txt", followed by pressing "get output". Copy the downloaded file into the specified folder.
(our download: 2017 March 06)
HOM_AllOrganism.rpt: Go to https://www.informatics.jax.org/orthology.shtml, select 'Download', then 'Vertebrate Homology'. Download the file 'HOM_AllOrganism.rpt' (right click, select 'Save link as'). Copy the file into the subdiretory specified above. Note that depending on the download date "DB Class Keys" are used instead of "HomoloGene IDs". Consequently, the download date needs to be specified in the C# script ("Global_class.Mgi_homologies_downloaded_2024_or_later_instead_of_2019 = " "true" or "false");
(our download: 2024 January 15)

---------------------------------------------

Subdirectory: ../Downloaded_datasets/
The files 'Chun_2023_downregulated_in_LVIP.txt' and 'Chun_2023_upregulated_in_LVIP.txt' were obtained by contacting the authors Chun et al. 2023 (PMID: 36970983).
PMID:35732739 or Chaffin et al 2022: Download the supplemental tables, open the files '2021-02-03277C-ST6.DCMvsNF.xlsx' and '2021-02-03277C-ST7.HCMvsNF.xlsx' and save them as text "(tab-delimited) (*.txt)" with the new names 'Chaffin_2022_singleNucleus_DCMvsNF.txt' and 'Chaffin_2022_singleNucleus_HCMvsNF.txt' into the specified folder.
PMID: 35959412 or https://www.nature.com/articles/s44161-022-00028-6: Download 'Supplementary Table 21 Healthy_DCM_Pseudo_DE'. On the first sheet delete all lines that do not contain an adjusted p-value (starting with line 22487). Generate a new column 'Cluster' and add 'DCM_vs_healthy_in_cardiomyocytes' to each line. On the sheet 'Fibroblasts' delete all lines with no adjusted pvalue (starting with 21199), add 'DCM_vs_healthy_in_fibroblasts' to each line in the new column 'Cluster'. Copy all fibroblast lines to the first sheet (excluding the header).  Delete all empty columns to the right of the last filled column (e.g., columns E - AG). If this step is skipped, the C# script might throw an exception due to existing columns that have the same column names (i.e. an empty string, ""). Save the document as in 'text (tab-delimited) (*.txt)' format with the name 'Koenig_2022_singleCell_DCMvsHealthy.txt'. Copy the file into the folder specified above.
https://www.heartcellatlas.org/: Select 'Version 1' in the upper right corner. Download the h5ad object 'Heart_global' and rename it into 'Litvinukova_2020_cellsAdultHumanHeart_global_raw.h5ad' into this folder.
(our download: 2022 August 10)

These downloads can be skipped, see below.

---------------------------------------------

Subdirectory: '../Cardiomyopathy_genomics/'
PMID: 33495597 or Harper et al. Nature Genetics volume 53, pages135–142 (2021): Copy the spreadsheet without the initial description (i.e., rows 5-155) into a new document and save it in 'text (tab-delimited) (*.txt)' format under the name 'Harper_2021_suppl_table_2.txt' into the specified folder.
PMID: 32382064 or Pirruccello Nature Communications volume 11, Article number: 2254 (2020): Download 'Supplementary Dataset 3', delete the lines with headline functions (i.e. lines 2, 25, 40, 63, 96, 125 and 138) and save it in 'text (tab-delimieted) (*.txt)' format under the name 'Pirruccello_2020_suppl_dataFile_3.txt' into the specified folder.

------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

Run the analysis

C# script:
Open the file "LINCS_SVD_manuscript.sln" with Visual Studio (https://visualstudio.microsoft.com/downloads/).
Using the solution explorer (right side of the screen, or if hidden, menu 'View' - 'Solution explorer') open 'LINCS_DToxS_SVD', right click on 'References' and select 'Manage NuGet packages..'.

--- instructions will follow ----

Using the solution explorer (right side of the screen, or if hidden, menu 'View' - 'Solution explorer') select the folder 'Common_classes'. Select the C# script 'Common_classes.cs'.
Open the class 'Global_directory_class" and define hard_drive (e.g., "D:/") and major_directory (e.g., "LINCs_DToxS_SVD/").
Open the C# script 'Code_file.cs'.
Depending on the available memory, set "Global_class.Memory_larger_than_16GB = " to "true" or "false". If set to false, algorithms generating suppl. figures 1A and B will be skipped.
Start debugging in the menue 'Debug' or by pressing F5.
Depending on the download date of the "MGI_homologene.txt" file, set "Global_class.Mgi_homologies_downloaded_2024_or_later_instead_of_2019" to "true" or "false". The 2024 version uses "DB Class Keys", while the 2019 version uses "HomoloGene ID". Our C# script needs to know, which column names to look for.

R-scripts:
Install R (https://www.r-project.org/).
Install Rtools (https://cran.r-project.org/bin/windows/Rtools/)
Open the file 'SVD_0000000_main_Run_pipeline.R' with any text or R code editor.
Depending on the available memory, set "memory_larget_than_16GB = " to "TRUE" or "FALSE". If set to false, algorithms generating suppl. figures 1A and B will be skipped.
Set the working directory that contains all R code files in the R-file 'SVD_0000_Set_working_directory.R'
(e.g, working_directory = "D:/LINCs_DToxS_SVD/R_code/").
Save your changes.
Open the file 'SVD_global_parameter.R' with any text or R code editor.
Set the overall_lincs_directory that contains all subdirectories in the R-file 'SVD_global_parameter.R'
(e.g., overall_lincs_directory = "D:/LINCs_DToxS_SVD/")
Set the number of available cores for parallel processing in the R-file 'SVD_global_parameter.R'.
Save your changes.
Start running the file 'SVD_0000000_main_Run_pipeline.R', by coping it into the R user interface (https://www.r-project.org/) or using the functionalities of any suited R code editor.
R libraries used by our pipeline will be installed automatically by the script 'SVD_00_install_missing_packages.R'.

---- instructions are missing ----

C# and R-script process the data in a successive order that is documented in the 'Code_file.sc' of the C# solution. Whenever one script finishes its current analysis part, it will write a file into the results folder. The other script will wait with the next analysis step until, it reads that file. C# and R-script check every 30 min for updated result files.

------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

Output:
- The results folder "./Results/SVD_manuscript_supplTables/" will contain all Supplemental tables that contain results generated from the data (Suppl. Tables 3 - 32).
- The results folder "./Results/SVD_manuscript_figures/" will contain PDFs, image files and graphml-files that were used to generate Main and Supplemental figures.
  Graphml files can be visualized using yED graph editor (https://www.yworks.com/products/yed/download).

------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

SKIP of single cell RNAseq analysis:
We assume that most users want to skip the analysis of the sc/sn RNAseq datasets that are very time consumptive. Therefore, we provide the enrichment results for all single cell RNAseq datasets as described under 'Subdirectory: ../Results/ScSnRNAseq_enrichment/'
If you want to include these steps, you have to uncomment the C# code lines by deleting '\\' at the beginning of each of the following lines:
\\SingleCellNucleusRNAseq_analysis_class scSnRNAseq = new SingleCellNucleusRNAseq_analysis_class();
\\scSnRNAseq.Do_enrichment_analysis_for_Schaniel_iPSCdCM_singleCell_cardiomyocyte();
\\scSnRNAseq.Do_enrichment_analysis_for_Litvinukova_2020_cellsAdultHumanHeart();
\\scSnRNAseq.Do_enrichment_analysis_for_chaffin_koenig_and_chun_HCM_DCM_vs_NF();

Similarly, you have to uncomment the corresponding command lines in R 'SVD_0000000_main_Run_pipeline.R' by deleting '#' at the beginning of each of the following lines:
#source('SVD_0a_singleCell.R')
#source('SVD_0b_HeartCellAtlas_singleCell.R)

-------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

System requirements/Performance:
High-performance computer
C# and R-code were developed on a high-performance computer with 40 cores and 384 GB RAM that used Windows 10 Pro as an operating system.
C# code was developed using Microsoft Visual Studio Community 2022 version 17.5.5 (https://visualstudio.microsoft.com/downloads/), R code using R version 4.1.0 and Rstudio 2023.06.1 Build 524.
On this system, the whole pipeline finishes within less than 10 hours.

Laptop with 16GB memory
Code was optimized to also run on a laptop with 16GB memory and one core. All main and almost all supplemental figures can be reproduced on a similar computer (except Suppl. Figures 1A and B).
Number of cores was set to 1 in the R-file 'SVD_global_parameter.R', "Global_class.Memory_larger_than_16GB = " to "false".
On this system, the pipeline finishes within a similar time period, except running the file 'SVD_5_validate_clusters_by_calculating_f1_scores_basedOnDrugSpecificEigenarrays_for_test_sets.R' with only one core can take a few days.